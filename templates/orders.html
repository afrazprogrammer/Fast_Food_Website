{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/orders.css' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playwrite+GB+S:ital,wght@0,100..400;1,100..400&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <title>Orders | Quick Taste</title>
</head>
<body>
    <div id="landing_header">
        <a href='#'><h2 id="landing_header_left">
            Quick Taste
        </h2></a>
        <div id="landing_header_right">
            <a href="/">Home</a>
            <a href="/about">About</a>
            <a href="/menu/burgers">Menu</a>
            <a href="/reservations">Reservations</a>
            <a href="/contact">Contact</a>
            <button id="hidden_menu_button"><img id="hidden_menu" src="https://static.thenounproject.com/png/356889-200.png" /></button>
        </div>
    </div>
    <div id="divider_container"><div id="divider"></div></div>
    <div id="orders_container">
        <h3>Your Orders</h3>
        <div id="detail_container">
            {% for i in data %}
            <div data-order-id="{{ i.id }}">
            {% for j, k in i.items %}
            <h4 class="order">{{ j }}
                {% if j == 'Items' %}
                <pre>:    {% for l, m in k.items %}{% for n in m %}{{ n }}, {% endfor %}{% endfor %}</pre>
                {% else %}
                <pre>:    {{ k }}</pre>
                {% endif %}
            </h4>
            {% endfor %}
            {% if request.session.type == "e" %}
            <button class="order-complete-btn">Order Complete</button>
            {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    <div id="footer">
        <h2>Contact: 000-000-0000</h2>
        <h2>Address: Shop 23-24, Ground Floor, Rose 1 Plaza, I-8 Markaz I 8 Markaz I-8, Islamabad, Islamabad Capital Territory 44790</h2>
    </div>
    <div id="hidden_menu_container">
        <button id="hidden_menu_button_2"><img id="hidden_menu" src="https://cdn-icons-png.flaticon.com/512/93/93634.png" /></button>
        <div>
            {% if not request.session.user %}
            <a href="/login">Log In</a>
            <a href="/signup">Sign Up</a>
            {% else %}
            <p>{{request.session.user}}</p>
            <a href="/bookings">Reservations</a>
            {% if request.session.type == "c" %}
            <a href="/orders">Your Orders</a>
            {% else %}
            <a href="/orders">Orders</a>
            <a href="/inventory">Inventory</a>
            {% endif %}
            <a href="/logout">Logout</a>
            {% endif %}
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.order-complete-btn').forEach(function(button) {
                button.addEventListener('click', function() {
                    var orderDiv = button.parentElement;
                    var orderh4 = orderDiv.querySelector('.order');
                    var orderId = orderh4.textContent;
                    orderId = orderId.replace(/\s+/g, '');
                    console.log(orderId)
                    orderId=orderId[orderId.length - 1]
                    console.log(orderId)
                    fetch('/orders', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'  // Ensure CSRF token is included
                        },
                        body: JSON.stringify({ order_id: orderId })
                    })
                    .then(response => {
                        if (response.ok) {
                            orderDiv.remove();  // Remove order from DOM
                        } else {
                            console.error('Failed to complete order');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                });
            });
        });
    </script>
    <script src="{% static 'js/orders.js' %}"></script>
</body>
</html>